<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta name="baidu-site-verification" content="UqlC4pwKIm" />
  <meta name="baidu-site-verification" content="d3U0dGeqGw" />
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.cat.net/css?family=Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Android,Service," />





  <link rel="alternate" href="/atom.xml" title="渡口一艘船" type="application/atom+xml" />






<meta name="description" content="service本篇博文主要介绍Service相关知识，具体目录如下  0x00 什么是Service Service是一个应用程序组件，可以在后台长时间运行的操作，不提供用户界面； 一个应用程序可以启动一个服务，它将继续在后台运行，即使用户切换到另外一个应用 一个组件可以绑定到一个服务与它交互，甚至执行进程间通信(IPC)，如处理网络传输、音乐播放、执行文件I/O，与content provid">
<meta name="keywords" content="Android,Service">
<meta property="og:type" content="article">
<meta property="og:title" content="service">
<meta property="og:url" content="https://xsfelvis.github.io/2017/10/31/Service/index.html">
<meta property="og:site_name" content="渡口一艘船">
<meta property="og:description" content="service本篇博文主要介绍Service相关知识，具体目录如下  0x00 什么是Service Service是一个应用程序组件，可以在后台长时间运行的操作，不提供用户界面； 一个应用程序可以启动一个服务，它将继续在后台运行，即使用户切换到另外一个应用 一个组件可以绑定到一个服务与它交互，甚至执行进程间通信(IPC)，如处理网络传输、音乐播放、执行文件I/O，与content provid">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/RjNWNs2.png">
<meta property="og:image" content="https://i.imgur.com/36H22oh.png">
<meta property="og:image" content="https://i.imgur.com/YrN3X1w.png">
<meta property="og:image" content="https://i.imgur.com/u6dBylu.png">
<meta property="og:image" content="https://i.imgur.com/cbwBY5P.png">
<meta property="og:updated_time" content="2018-06-04T08:39:57.734Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="service">
<meta name="twitter:description" content="service本篇博文主要介绍Service相关知识，具体目录如下  0x00 什么是Service Service是一个应用程序组件，可以在后台长时间运行的操作，不提供用户界面； 一个应用程序可以启动一个服务，它将继续在后台运行，即使用户切换到另外一个应用 一个组件可以绑定到一个服务与它交互，甚至执行进程间通信(IPC)，如处理网络传输、音乐播放、执行文件I/O，与content provid">
<meta name="twitter:image" content="https://i.imgur.com/RjNWNs2.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://xsfelvis.github.io/2017/10/31/Service/"/>





  <title>service | 渡口一艘船</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-120283281-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2a3365c396bc1892919405bfc6ea04a8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">渡口一艘船</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">不积跬步，无以至千里；不积小流，无以成江海</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://xsfelvis.github.io/2017/10/31/Service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="云来">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="渡口一艘船">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">service</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-31T00:00:00+08:00">
                2017-10-31
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-06-04T16:39:57+08:00">
                2018-06-04
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/10/31/Service/" class="leancloud_visitors" data-flag-title="service">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,966
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  15
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <script src="/assets/js/APlayer.min.js"> </script><h1 id="service"><a href="#service" class="headerlink" title="service"></a>service</h1><p>本篇博文主要介绍Service相关知识，具体目录如下</p>
<p><img src="https://i.imgur.com/RjNWNs2.png" alt=""></p>
<h2 id="0x00-什么是Service"><a href="#0x00-什么是Service" class="headerlink" title="0x00 什么是Service"></a>0x00 什么是Service</h2><ul>
<li>Service是一个应用程序组件，可以在后台长时间运行的操作，不提供用户界面；</li>
<li>一个应用程序可以启动一个服务，它将继续在后台运行，即使用户切换到另外一个应用</li>
<li>一个组件可以绑定到一个服务与它交互，甚至执行进程间通信(IPC)，如处理网络传输、音乐播放、执行文件I/O，与content provider进行交互等。</li>
</ul>
<h2 id="0x01-服务的分类"><a href="#0x01-服务的分类" class="headerlink" title="0x01 服务的分类"></a>0x01 服务的分类</h2><ul>
<li><p>按照运行地点分类</p>
<p>|           类别           |         区别         |                                                                                                        优点                                                                                                       | 缺点                                                                  | 应用                                             |<br>|:————————:|:——————–:|:—————————————————————————————————————————————————————————————————————–:|———————————————————————–|————————————————–|<br>| 本地服务(Local Service)  | 该服务依附在主进程上 | 服务依附在主进程上而不是独立的进程，这样在一定程度上节约了资源，另外Local服务因为是在同一进程因此不需要IPC，也不需要AIDL。相应bindService会方便很多。                                                             | 主进程被Kill后，服务便会终止。                                        | 如：音乐播放器播放等不需要常驻的服务。           |<br>| 远程服务(Remote Service) | 该服务是独立的进程   | 服务为独立的进程，对应进程名格式为所在包名加上你指定的android:process字符串。由于是独立的进程，因此在Activity所在进程被Kill的时候，该服务依然在运行，不受其他进程影响，有利于为多个进程提供服务具有较高的灵活性。 | 该服务是独立的进程，会占用一定资源，并且使用AIDL进行IPC稍微麻烦一点。 | 一些提供系统服务的Service，这种Service是常驻的。 |</p>
</li>
</ul>
<ul>
<li>按运行类型分类</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">类别</th>
<th style="text-align:center">区别</th>
<th>应用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">前台服务</td>
<td style="text-align:center">会在通知栏显示onGoing的 Notification</td>
<td>当服务被终止的时候，通知一栏的 Notification 也会消失，这样对于用户有一定的通知作用。常见的如音乐播放服务。</td>
</tr>
<tr>
<td style="text-align:center">后台服务</td>
<td style="text-align:center">默认的服务即为后台服务，即不会在通知一栏显示 onGoing的 Notification。</td>
<td>当服务被终止的时候，用户是看不到效果的。某些不需要运行或终止提示的服务，如天气更新，日期同步，邮件同步等。</td>
</tr>
</tbody>
</table>
<ul>
<li>按使用方式分类</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">类别</th>
<th style="text-align:center">区别</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">startService启动的服务</td>
<td style="text-align:center">主要用于启动一个服务执行后台任务，不进行通信。停止服务使用stopService。</td>
</tr>
<tr>
<td style="text-align:center">bindService启动的服务</td>
<td style="text-align:center">方法启动的服务要进行通信。停止服务使用unbindService。</td>
</tr>
<tr>
<td style="text-align:center">同时使用startService、bindService 启动的服务</td>
<td style="text-align:center">停止服务应同时使用stopService与unbindService。</td>
</tr>
</tbody>
</table>
<h2 id="0x02-生命周期"><a href="#0x02-生命周期" class="headerlink" title="0x02 生命周期"></a>0x02 生命周期</h2><p>如使用方式分类所提，service使用常分为两大类，start、bind</p>
<ul>
<li><p>如果一个应用程序组件（比如一个activity）通过调用startService()来启动服务，则该服务就是被“started”了。一旦被启动，服务就能在后台一直运行下去，即使启动它的组件已经被销毁了。<br>通常，started的服务执行单一的操作并且不会向调用者返回结果。比如，它可以通过网络下载或上传文件。当操作完成后，服务应该自行终止。</p>
</li>
<li><p>如果一个应用程序组件通过调用bindService()绑定到服务上，则该服务就是被“bound”了。bound服务提供了一个客户端/服务器接口，允许组件与服务进行交互、发送请求、获取结果，甚至可以利用进程间通信（IPC）跨进程执行这些操作。绑定服务的生存期和被绑定的应用程序组件一致。<br>多个组件可以同时与一个服务绑定，不过所有的组件解除绑定后，服务也就会被销毁。</p>
</li>
</ul>
<p>二者的生命周期如下：</p>
<p><img src="https://i.imgur.com/36H22oh.png" alt=""></p>
<p>对应的方法解释如下：</p>
<ul>
<li>4个手动调用的方法</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">手动调用方法</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">startService()</td>
<td style="text-align:center">启动服务</td>
</tr>
<tr>
<td style="text-align:center">stopService()</td>
<td style="text-align:center">关闭服务</td>
</tr>
<tr>
<td style="text-align:center">stopSelf()</td>
<td style="text-align:center">关闭服务</td>
</tr>
<tr>
<td style="text-align:center">bindService()</td>
<td style="text-align:center">绑定服务</td>
</tr>
<tr>
<td style="text-align:center">unbindService()</td>
<td style="text-align:center">解绑服务</td>
</tr>
</tbody>
</table>
<ul>
<li>5个内部调用的方法</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">内部调用的方法</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">onCreat()</td>
<td style="text-align:center">创建服务</td>
</tr>
<tr>
<td style="text-align:center">onStartCommand()</td>
<td style="text-align:center">开始服务</td>
</tr>
<tr>
<td style="text-align:center">onDestroy()</td>
<td style="text-align:center">销毁服务</td>
</tr>
<tr>
<td style="text-align:center">onBind()</td>
<td style="text-align:center">绑定服务</td>
</tr>
<tr>
<td style="text-align:center">onUnbind()</td>
<td style="text-align:center">解绑服务</td>
</tr>
</tbody>
</table>
<p>其中需要注意以下几点：</p>
<ul>
<li>startService()和stopService()只能开启和关闭Service，无法操作Service；bindService()和unbindService()可以操作Service</li>
<li>startService开启的Service，调用者退出后Service仍然存在；BindService开启的Service，调用者退出后，Service随着调用者销毁。</li>
</ul>
<h2 id="0x03-如何使用"><a href="#0x03-如何使用" class="headerlink" title="0x03 如何使用"></a>0x03 如何使用</h2><p>建议参照demo学习<a href="https://github.com/xsfelvis/ServiceAIDLStudyDemo.git" target="_blank" rel="noopener">https://github.com/xsfelvis/ServiceAIDLStudyDemo.git</a></p>
<p><img src="https://i.imgur.com/YrN3X1w.png" alt=""></p>
<p><strong>本地Service(startService)</strong></p>
<p>通过start启动的service一旦被启动，服务一般会在后台一直运行即使启动它的的组件已经销毁了，而且<code>不会像调用者返回结果</code>，如可以通过它进行网络下载或者上传文件，当操作完成后，该服务自行终止。</p>
<blockquote>
<p>Step 1 在AndroidManifest中注册Service</p>
</blockquote>
<p>其中一些相关属性需要重点说明下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">属性</th>
<th style="text-align:center">说明</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">android:name</td>
<td style="text-align:center">Service的类名</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">android:label</td>
<td style="text-align:center">Service的名字</td>
<td>若不设置默认为Service类名</td>
</tr>
<tr>
<td style="text-align:center">android:icon</td>
<td style="text-align:center">Service的图标</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">android:permission</td>
<td style="text-align:center">申明此Service的权限</td>
<td>有提供了该权限的应用才能控制或连接此服务</td>
</tr>
<tr>
<td style="text-align:center">android:process</td>
<td style="text-align:center">表示该服务是否在另一个进程中运行（远程服务)</td>
<td>不设置默认为本地服务；remote则设置成远程服务</td>
</tr>
<tr>
<td style="text-align:center">android:enabled</td>
<td style="text-align:center">系统默认启动</td>
<td>true：Service 将会默认被系统启动；不设置则默认为false</td>
</tr>
<tr>
<td style="text-align:center">android:exported</td>
<td style="text-align:center">该服务是否能够被其他应用程序所控制或连接</td>
<td>不设置默认此项为 false</td>
</tr>
</tbody>
</table>
<blockquote>
<p>step 2 新建子类继承自Service类</p>
</blockquote>
<p>需要重写onCreate()、onStartCommand()、onDestroy()和onBind()方法</p>
<blockquote>
<p>step 3 构建用于启动Service的intent对象</p>
<p>step 4 调用startService启动，调用stopService/stopSelf停止服务</p>
</blockquote>
<pre><code>@Override
public void onCreate() {
    //这里配置一些信息
    //启动运行服务的线程。
    //请记住我们要创建一个单独的线程，因为服务通常运行于进程的主线程中，可我们不想阻塞主线程。
    //我们还要赋予它后台运行的优先级，以便计算密集的工作不会干扰我们的UI。
    HandlerThread handlerThread = new HandlerThread(TAG);
    handlerThread.start();
    //获取handlerThread的loop队列并用于Handler
    mServiceLooper = handlerThread.getLooper();
    mServiceHandler = new ServiceHandler(mServiceLooper);
    Log.d(TAG, &quot;onCreate&quot;);
}

@Override
public int onStartCommand(Intent intent, int flags, int startId) {
    msgStr = intent.getStringExtra(&quot;startService&quot;);
    Log.d(TAG, &quot;onStartCommand getExtraString = &quot; + msgStr);
    //对于每一个启动请求，都发送一个消息来启动一个处理
    //同时传入启动ID，以便任务完成后我们知道该终止哪一个请求。
    Message message = mServiceHandler.obtainMessage();
    message.arg1 = 1;
    mServiceHandler.sendMessage(message);
    //如果我们被杀死了，那从这里返回之后被重启
    return START_STICKY;
}
</code></pre><p>由于Service也是运行在主线程中，如果需要执行一些耗时操作需要放到相应的子线程中处理，谷歌内置了一个<code>IntentService(异步处理服务)</code>，</p>
<p>它会新开一个线程：handlerThread在线程中发消息，然后接受处理完成后，会清理线程，并且关掉服务。</p>
<p>IntentService有以下特点：</p>
<p>（1） 它创建了一个独立的工作线程来处理所有的通过onStartCommand()传递给服务的intents。</p>
<p>（2） 创建了一个工作队列，来逐个发送intent给onHandleIntent()。</p>
<p>（3） 不需要主动调用stopSelft()来结束服务。因为，在所有的intent被处理完后，系统会自动关闭服务。</p>
<p>（4） 默认实现的onBind()返回null</p>
<p>（5） 默认实现的onStartCommand()的目的是将intent插入到工作队列中</p>
<p>其中intentService在5.0系统中需要显示启动</p>
<p>在之前的例子中我们自己手动维护了一个handleThread去处理耗时操作，intentService已经自带了，然后用户只要是实现onHandleIntent去处理新的业务即可</p>
<pre><code>/**
 * IntentService从缺省的工作线程中调用本方法，并用启动服务的intent作为参数。
 * 本方法返回后，IntentService将适时终止这个服务。
 */

@Override
protected void onHandleIntent(@Nullable Intent intent) {
    //根据Intent的不同进行不同的事务处理
    String taskName = intent.getExtras().getString(&quot;taskName&quot;);
    switch (taskName) {
        case &quot;task1&quot;:
            Log.d(TAG, &quot;do task1&quot;);
            break;
        case &quot;task2&quot;:
            Log.d(TAG, &quot;do task2&quot;);
            break;
        default:
            break;
    }

}
</code></pre><p>以上两种均在demo中有所实现</p>
<p><strong>可通信Service(bind) </strong></p>
<blockquote>
<p>如果一个应用程序组件通过调用bindService()绑定到服务上，bound服务提供了一个客户端/服务器接口，<code>允许组件与服务进行交互、发送请求、获取结果，甚至可以利用进程间通信（IPC）跨进程执行这些操作</code>。绑定服务的生存期和被绑定的应用程序组件一致。多个组件可以同时与一个服务绑定，不过所有的组件解除绑定后，服务也就会被销毁。</p>
</blockquote>
<ul>
<li><p>使用场景<br>当客户端和服务位于同一个应用程序的进程中，(如一个音乐应用需要把Activity绑定到它自己的后台音乐播放上)</p>
</li>
<li><p>使用步骤</p>
</li>
</ul>
<ol>
<li><p>在你的服务中创建一个Binder的实例，通常需要实现以下3点之一</p>
<ul>
<li>包含了可供客户端调用的公共方法，如demo中的 <code>getHelloBoundService()</code>方法</li>
<li>返回当前Service实例，其中包含了可供客户端调用的公共方法，如demo中的<code>getRandomNumber</code></li>
<li>或者，返回内含服务类的其它类的一个实例，服务中包含了可供客户端调用的公共方法，</li>
</ul>
</li>
<li><p>从回调方法onBinder()返回Binder的实例</p>
</li>
<li>在客户端中，在回调方法onServiceConnected()中接收Binder并用所提供的方法对绑定的服务进行调用，不过服务和客户端之所以必须位于同一个应用程序中，是为了让客户端能够正确转换（cast）返回的对象并调用对象的API。<br>服务和客户端也必须位于同一个进程中，因为这种方式不能执行任何跨进程的序列化（marshalling）操作。</li>
</ol>
<ul>
<li>Tips</li>
</ul>
<ol>
<li>在没有bind时执行unbind，会报Service not registered crash，可以增加标志位控制bind、unbind可以参看demo中的unbind操作</li>
<li>ServiceConnection中重写2个方法<code>onServiceConnected</code>、<code>onServiceDisconnected</code>，其中bindService会触发onServiceConnected，而unbinderService不会触发onServiceDisconnected；<code>onServiceDisconnected</code>在系统在内存不足的时候可以优先杀死这个服务</li>
</ol>
<p><strong>前台service</strong></p>
<p>前台service和后台service最大的区别在于</p>
<ul>
<li>前台service在下来通知栏有显示通知，但是后台service没有</li>
<li>前台service优先级较高，不会由于系统内存不足而被回收，而后台service优先级比较低，当系统出现内存不足情况时有可能被回收</li>
</ul>
<p>与普通service使用类似，核心是增加构建通知部分的处理，具体可以查看demo中代码</p>
<pre><code>public int onStartCommand(Intent intent, int flags, int startId) {
    //API11之后构建Notification的方式
    Notification.Builder builder = new Notification.Builder(this);
    Intent frontServiceIntent = new Intent(this, MainActivity.class);
    PendingIntent frontServicePeningIntent = PendingIntent.getActivity(this, 0, frontServiceIntent, 0);
    builder.setContentIntent(frontServicePeningIntent)
            .setContentTitle(&quot;下拉列表中的Title&quot;)
            .setContentText(&quot;要显示的内容&quot;)
            .setSmallIcon(R.mipmap.ic_front_small)
            .setLargeIcon(BitmapFactory.decodeResource(this.getResources(), R.mipmap.ic_front_big))
            .setWhen(System.currentTimeMillis());
    Notification notification = builder.getNotification();
    notification.defaults = Notification.DEFAULT_SOUND;
    // 参数一：唯一的通知标识；参数二：通知消息。
    startForeground(110, notification);// 开始前台服务
    return START_STICKY;
}
</code></pre><p><strong>远程service</strong></p>
<p>主要是为了让Service与多个应用程序的组件进行跨进程通信(IPC)，这里涉及到两个概念</p>
<ul>
<li>IPC：Inter-Process Communication，即跨进程通信</li>
<li>AIDL：Android Interface Definition Language，即Android接口定义语言；用于让某个Service与多个应用程序组件之间进行跨进程通信，从而可以实现多个应用程序共享同一个Service的功能。</li>
</ul>
<p>AIDL（Android 接口定义语言）与您可能使用过的其他 IDL 类似。 您可以利用它定义客户端与服务使用进程间通信 (IPC) 进行相互通信时都认可的编程接口。 在 Android 上，一个进程通常无法访问另一个进程的内存。 尽管如此，进程需要将其对象分解成操作系统能够识别的原语，并将对象编组成跨越边界的对象。 编写执行这一编组操作的代码是一项繁琐的工作，因此 Android 会使用 AIDL 来处理。</p>
<p>并且谷歌特意注明了AIDL使用的场景</p>
<blockquote>
<p>注：只有允许不同应用的客户端用 IPC 方式访问服务，并且想要在服务中处理多线程时，才有必要使用 AIDL。 如果您不需要执行跨越不同应用的并发 IPC，就应该通过实现一个 Binder 创建接口；或者，如果您想执行 IPC，但根本不需要处理多线程，则使用 Messenger 类来实现接口。无论如何，在实现 AIDL 之前，请您务必理解绑定服务。</p>
</blockquote>
<p>首先新建一个aidl文件</p>
<pre><code>interface IAidlService {

     void aidlService();
}
</code></pre><p>然后make一下，在build/generated/source/aidl文件下生成一个接口文件</p>
<p>在使用到通信的地方使用这个接口文件中的api，AIDLService1.Stub.asInterface()</p>
<pre><code>mAidlServiceConnection = new ServiceConnection() {

    //重写onServiceConnected()方法和onServiceDisconnected()方法
    //在Activity与Service建立关联和解除关联的时候调用
    @Override
    public void onServiceDisconnected(ComponentName name) {
    }

    //在Activity与Service建立关联时调用
    @Override
    public void onServiceConnected(ComponentName name, IBinder service) {
        //使用AIDLService1.Stub.asInterface()方法将传入的IBinder对象传换成了mServerAidlService对象
        mServerAidlService = IAidlService.Stub.asInterface(service);

        try {
            //通过该对象调用在MyAIDLService.aidl文件中定义的接口方法,从而实现跨进程通信
            mServerAidlService.aidlService();

        } catch (RemoteException e) {
            e.printStackTrace();
        }
    }
};
</code></pre><p>可以看出二者不在一个线程中</p>
<p><img src="https://i.imgur.com/u6dBylu.png" alt=""><br><img src="https://i.imgur.com/cbwBY5P.png" alt=""></p>
<p>具体代码在demo中~</p>
<h2 id="0x04-一些容易混淆的点"><a href="#0x04-一些容易混淆的点" class="headerlink" title="0x04 一些容易混淆的点"></a>0x04 一些容易混淆的点</h2><p><strong>Service和Thread的区别</strong></p>
<p>官方有两点描述</p>
<ul>
<li>1.A Service is not a separate process. The Service object itself does<br>not imply it is running in its own process; unless otherwise specified,<br>it runs in the same process as the application it is part of.</li>
<li>2.A Service is not a thread. It is not a means itself to do work off<br>of the main thread (to avoid Application Not Responding errors).</li>
</ul>
<p>第二点清楚提到不是一个thread，只是有些时候二者均工作在后台而已。</p>
<p>service和调用者之间的通讯都是同步的（不论是远程service还是本地service），它跟线程一点关系都没有！</p>
<p><strong>service和intentService之间区别</strong></p>
<ul>
<li>1.Service：依赖于应用程序的主线程不要误以为是独立的进程 or 线程，因此不能处理耗时操作,否则就会报ANR(Activity—–&gt;5秒<br>Broadcast—–&gt;10秒,Service—–&gt;20秒)，而intentService内部启动一个HandleThread工作线程来去处理耗时任务</li>
<li><ol>
<li>Service需要主动调用stopSelf()来结束服务，而IntentService不需要（在所有intent被处理完后，系统会自动关闭服务，内部调用了stopself()方法）</li>
</ol>
</li>
</ul>
<p><strong>IntentService与线程的区别</strong></p>
<ul>
<li>intentService内部采用了HandlerThread实现，作用类似于后台线程；与后台线程相比，IntentService是一种后台服务，优势是：优先级高（不容易被系统杀死），从而保证任务的执行</li>
<li>在应用中，如果是长时间的在后台运行，而且不需要交互的情况下，使用服务。</li>
<li>同样是在后台运行，不需要交互的情况下，如果只是完成某个任务，之后就不需要运行，而且可能是多个任务，需要长时间运行的情况下使用线程。</li>
<li>如果任务占用CPU时间多，资源大的情况下，要使用线程。</li>
</ul>
<h2 id="0x05-小结"><a href="#0x05-小结" class="headerlink" title="0x05 小结"></a>0x05 小结</h2><p>service是Android 四大组件之一，掌握好它对平时的开发有着莫大益处，本文只是介绍了service的常见用法和一些容易混淆的点，还有一些深入的点比如aidl数据传递、自定义notification定制化和在不同android版本的坑，这些都需要在实际开发中遇到再去针对性处理了~</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="https://developer.android.com/guide/components/services.html?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.com/guide/components/services.html?hl=zh-cn</a></li>
<li><a href="https://developer.android.com/guide/components/bound-services.html?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.com/guide/components/bound-services.html?hl=zh-cn</a></li>
<li><a href="https://developer.android.com/guide/components/aidl.html?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.com/guide/components/aidl.html?hl=zh-cn</a></li>
<li><a href="http://www.jianshu.com/p/1e49e93c3ec8" target="_blank" rel="noopener">http://www.jianshu.com/p/1e49e93c3ec8</a></li>
<li><a href="http://www.jianshu.com/p/8d0cde35eb10" target="_blank" rel="noopener">http://www.jianshu.com/p/8d0cde35eb10</a></li>
<li><a href="http://blog.csdn.net/luoyanglizi/article/details/51980630" target="_blank" rel="noopener">http://blog.csdn.net/luoyanglizi/article/details/51980630</a></li>
</ul>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    云来
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://xsfelvis.github.io/2017/10/31/Service/" title="service">https://xsfelvis.github.io/2017/10/31/Service/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/Service/" rel="tag"># Service</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div id="needsharebutton-postbottom">
            <span class="btn">
              <i class="fa fa-share-alt" aria-hidden="true"></i>
            </span>
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/03/Touch机制/" rel="next" title="Touch机制">
                <i class="fa fa-chevron-left"></i> Touch机制
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/06/动态权限1/" rel="prev" title="动态权限">
                动态权限 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNzA1My8xMzU4OQ=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="云来" />
            
              <p class="site-author-name" itemprop="name">云来</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

			<!--my custom code begin-->
			<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.5.0/velocity.min.js"></script>
			<script type="text/javascript">
			  $("#sidebar").hover(function(){
				$("#mydivshow").velocity('stop').velocity({opacity: 1});
			  },function(){
				$("#mydivshow").velocity('stop').velocity({opacity: 0});
			  });
			</script>
			<div id="mydivshow" class="mydivshow">
			<!--my custom code end-->
			
          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/xsfelvis" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://blog.csdn.net/XSF50717" target="_blank" title="CSDN">
                    
                      <i class="fa fa-fw fa-csdn"></i>CSDN</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://juejin.im/user/5643754060b27f7a018bd10d" target="_blank" title="掘金">
                    
                      <i class="fa fa-fw fa-juejin"></i>掘金</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:xsfelvis@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://juejin.im/timeline" title="稀土掘金" target="_blank">稀土掘金</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://gank.io/" title="干货集中营" target="_blank">干货集中营</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wanandroid.com/tools" title="玩Android" target="_blank">玩Android</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://tech.meituan.com/" title="美团点评" target="_blank">美团点评</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.androidblog.cn/about/" title="酷站" target="_blank">酷站</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://pingguohe.net/" title="苹果核" target="_blank">苹果核</a>
                  </li>
                
              </ul>
            </div>
          

          <div id="player1" class="aplayer"></div>
<script src="/js/src/APlayer.min.js"></script>
<script type="text/javascript">
var ap = new APlayer({
    element: document.getElementById('player1'),                       // Optional, player element
    narrow: false,                                                     // Optional, narrow style
    autoplay: false,                                                    // Optional, autoplay song(s), not supported by mobile browsers
    showlrc: 0,                                                        // Optional, show lrc, can be 0, 1, 2, see: ###With lrc
    mutex: true,                                                       // Optional, pause other players when this player playing
    theme: '#e6d0b2',                                                  // Optional, theme color, default: #b7daff
    mode: 'random',                                                    // Optional, play mode, can be `random` `single` `circulation`(loop) `order`(no loop), default: `circulation`
    preload: 'metadata',                                               // Optional, the way to load music, can be 'none' 'metadata' 'auto', default: 'auto'
    listmaxheight: '513px',                                             // Optional, max height of play list
    music: {                                                           // Required, music info, see: ###With playlist
        title: 'Summertime Sadness',                                          // Required, music title
        author: 'cover',                          // Required, music author
        url: 'http://www.170mv.com/kw/other.web.rb01.sycdn.kuwo.cn/resource/n2/71/36/4211820203.mp3',  // Required, music url
        pic: '/images/music.jpg',  // Optional, music picture
    }
});
</script>
        </div>
		<!--my custom code begin-->
		</div>
		<!--my custom code end-->
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#service"><span class="nav-number">1.</span> <span class="nav-text">service</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-什么是Service"><span class="nav-number">1.1.</span> <span class="nav-text">0x00 什么是Service</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-服务的分类"><span class="nav-number">1.2.</span> <span class="nav-text">0x01 服务的分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-生命周期"><span class="nav-number">1.3.</span> <span class="nav-text">0x02 生命周期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-如何使用"><span class="nav-number">1.4.</span> <span class="nav-text">0x03 如何使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-一些容易混淆的点"><span class="nav-number">1.5.</span> <span class="nav-text">0x04 一些容易混淆的点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-小结"><span class="nav-number">1.6.</span> <span class="nav-text">0x05 小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-number">1.7.</span> <span class="nav-text">参考文档</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">云来</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">41.9k</span>
  
</div>






  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  


<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>




  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("QFKdnKcTHhFexYDWSA4tMBzH-gzGzoHsz", "wq2r6eiGoNMmUhgBsA7hAO9a");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.3"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.3"></script>


  
  <script type="text/javascript" src="/js/src/exturl.js?v=5.1.3"></script>


  <script src="/js/src/Aplayer-Controler.js"></script>
<div id="AP-controler"></div>
<script type="text/javascript">
var myapc=new APlayer_Controler({
		APC_dom:$('#AP-controler'),
		aplayer:ap, //此为绑定的aplayer对象
		attach_right:false,
		position:{top:'300px',bottom:''},
		fixed:true,
		btn_width:100,
		btn_height:120,
		img_src:['http://oty1v077k.bkt.clouddn.com/bukagirl.jpg',
				'http://oty1v077k.bkt.clouddn.com/jumpgirl.jpg',
				'http://oty1v077k.bkt.clouddn.com/pentigirl.jpg',
				'http://oty1v077k.bkt.clouddn.com/%E8%90%8C1.gif'],
		img_style:{repeat:'no-repeat',position:'center',size:'contain'},
		ctrls_color:'rgba(173,255,47,0.8)',
		ctrls_hover_color:'rgba(255,140,0,0.7)',
		tips_on:true,
		tips_width:140,
		tips_height:25,
		tips_color:'rgba(255,255,255,0.6)',
		tips_content:{},
		timeout:30
	});
</script>
  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>



</body>
</html>
